"use strict";

function _typeof(obj) { if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") { _typeof = function _typeof(obj) { return typeof obj; }; } else { _typeof = function _typeof(obj) { return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj; }; } return _typeof(obj); }

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.applyExtends = void 0;

var fs = require("fs");

var path = require("path");

var yerror_1 = require("./yerror");

var previouslyVisitedConfigs = [];

function checkForCircularExtends(cfgPath) {
  if (previouslyVisitedConfigs.indexOf(cfgPath) > -1) {
    throw new yerror_1.YError("Circular extended configurations: '".concat(cfgPath, "'."));
  }
}

function getPathToDefaultConfig(cwd, pathToExtend) {
  return path.resolve(cwd, pathToExtend);
}

function mergeDeep(config1, config2) {
  var target = {};

  function isObject(obj) {
    return obj && _typeof(obj) === 'object' && !Array.isArray(obj);
  }

  Object.assign(target, config1);

  for (var _i = 0, _Object$keys = Object.keys(config2); _i < _Object$keys.length; _i++) {
    var key = _Object$keys[_i];

    if (isObject(config2[key]) && isObject(target[key])) {
      target[key] = mergeDeep(config1[key], config2[key]);
    } else {
      target[key] = config2[key];
    }
  }

  return target;
}

function applyExtends(config, cwd) {
  var mergeExtends = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : false;
  var defaultConfig = {};

  if (Object.prototype.hasOwnProperty.call(config, 'extends')) {
    if (typeof config["extends"] !== 'string') return defaultConfig;
    var isPath = /\.json|\..*rc$/.test(config["extends"]);
    var pathToDefault = null;

    if (!isPath) {
      try {
        pathToDefault = require.resolve(config["extends"]);
      } catch (err) {// most likely this simply isn't a module.
      }
    } else {
      pathToDefault = getPathToDefaultConfig(cwd, config["extends"]);
    } // maybe the module uses key for some other reason,
    // err on side of caution.


    if (!pathToDefault && !isPath) return config;
    if (!pathToDefault) throw new yerror_1.YError("Unable to find extended config '".concat(config["extends"], "' in '").concat(cwd, "'."));
    checkForCircularExtends(pathToDefault);
    previouslyVisitedConfigs.push(pathToDefault);
    defaultConfig = isPath ? JSON.parse(fs.readFileSync(pathToDefault, 'utf8')) : require(config["extends"]);
    delete config["extends"];
    defaultConfig = applyExtends(defaultConfig, path.dirname(pathToDefault), mergeExtends);
  }

  previouslyVisitedConfigs = [];
  return mergeExtends ? mergeDeep(defaultConfig, config) : Object.assign({}, defaultConfig, config);
}

exports.applyExtends = applyExtends;