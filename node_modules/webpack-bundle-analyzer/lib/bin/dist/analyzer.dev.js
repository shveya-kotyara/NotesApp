#! /usr/bin/env node
"use strict";

function _slicedToArray(arr, i) { return _arrayWithHoles(arr) || _iterableToArrayLimit(arr, i) || _nonIterableRest(); }

function _nonIterableRest() { throw new TypeError("Invalid attempt to destructure non-iterable instance"); }

function _iterableToArrayLimit(arr, i) { if (!(Symbol.iterator in Object(arr) || Object.prototype.toString.call(arr) === "[object Arguments]")) { return; } var _arr = []; var _n = true; var _d = false; var _e = undefined; try { for (var _i = arr[Symbol.iterator](), _s; !(_n = (_s = _i.next()).done); _n = true) { _arr.push(_s.value); if (i && _arr.length === i) break; } } catch (err) { _d = true; _e = err; } finally { try { if (!_n && _i["return"] != null) _i["return"](); } finally { if (_d) throw _e; } } return _arr; }

function _arrayWithHoles(arr) { if (Array.isArray(arr)) return arr; }

function _toConsumableArray(arr) { return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _nonIterableSpread(); }

function _nonIterableSpread() { throw new TypeError("Invalid attempt to spread non-iterable instance"); }

function _iterableToArray(iter) { if (Symbol.iterator in Object(iter) || Object.prototype.toString.call(iter) === "[object Arguments]") return Array.from(iter); }

function _arrayWithoutHoles(arr) { if (Array.isArray(arr)) { for (var i = 0, arr2 = new Array(arr.length); i < arr.length; i++) { arr2[i] = arr[i]; } return arr2; } }

var _require = require('path'),
    resolve = _require.resolve,
    dirname = _require.dirname;

var _ = require('lodash');

var commander = require('commander');

var _require2 = require('chalk'),
    magenta = _require2.magenta;

var analyzer = require('../analyzer');

var viewer = require('../viewer');

var Logger = require('../Logger');

var utils = require('../utils');

var SIZES = new Set(['stat', 'parsed', 'gzip']);
var program = commander.version(require('../../package.json').version).usage("<bundleStatsFile> [bundleDir] [options]\n\n  Arguments:\n  \n    bundleStatsFile  Path to Webpack Stats JSON file.\n    bundleDir        Directory containing all generated bundles.\n                     You should provided it if you want analyzer to show you the real parsed module sizes.\n                     By default a directory of stats file is used.").option('-m, --mode <mode>', 'Analyzer mode. Should be `server`,`static` or `json`.' + br('In `server` mode analyzer will start HTTP server to show bundle report.') + br('In `static` mode single HTML file with bundle report will be generated.') + br('In `json` mode single JSON file with bundle report will be generated.'), 'server').option( // Had to make `host` parameter optional in order to let `-h` flag output help message
// Fixes https://github.com/webpack-contrib/webpack-bundle-analyzer/issues/239
'-h, --host [host]', 'Host that will be used in `server` mode to start HTTP server.', '127.0.0.1').option('-p, --port <n>', 'Port that will be used in `server` mode to start HTTP server.', 8888).option('-r, --report <file>', 'Path to bundle report file that will be generated in `static` mode.').option('-t, --title <title>', 'String to use in title element of html report.').option('-s, --default-sizes <type>', 'Module sizes to show in treemap by default.' + br("Possible values: ".concat(_toConsumableArray(SIZES).join(', '))), 'parsed').option('-O, --no-open', "Don't open report in default browser automatically.").option('-e, --exclude <regexp>', 'Assets that should be excluded from the report.' + br('Can be specified multiple times.'), array()).option('-l, --log-level <level>', 'Log level.' + br("Possible values: ".concat(_toConsumableArray(Logger.levels).join(', '))), Logger.defaultLevel).parse(process.argv);

var mode = program.mode,
    host = program.host,
    port = program.port,
    reportFilename = program.report,
    reportTitle = program.title,
    defaultSizes = program.defaultSizes,
    logLevel = program.logLevel,
    openBrowser = program.open,
    excludeAssets = program.exclude,
    _program$args = _slicedToArray(program.args, 2),
    bundleStatsFile = _program$args[0],
    bundleDir = _program$args[1];

var logger = new Logger(logLevel);

if (typeof reportTitle === 'undefined') {
  reportTitle = utils.defaultTitle;
}

if (!bundleStatsFile) showHelp('Provide path to Webpack Stats file as first argument');

if (mode !== 'server' && mode !== 'static' && mode !== 'json') {
  showHelp('Invalid mode. Should be either `server`, `static` or `json`.');
}

if (mode === 'server') {
  if (!host) showHelp('Invalid host name');
  port = port === 'auto' ? 0 : Number(port);
  if (isNaN(port)) showHelp('Invalid port. Should be a number or `auto`');
}

if (!SIZES.has(defaultSizes)) showHelp("Invalid default sizes option. Possible values are: ".concat(_toConsumableArray(SIZES).join(', ')));
bundleStatsFile = resolve(bundleStatsFile);
if (!bundleDir) bundleDir = dirname(bundleStatsFile);
var bundleStats;

try {
  bundleStats = analyzer.readStatsFromFile(bundleStatsFile);
} catch (err) {
  logger.error("Couldn't read webpack bundle stats from \"".concat(bundleStatsFile, "\":\n").concat(err));
  logger.debug(err.stack);
  process.exit(1);
}

if (mode === 'server') {
  viewer.startServer(bundleStats, {
    openBrowser: openBrowser,
    port: port,
    host: host,
    defaultSizes: defaultSizes,
    reportTitle: reportTitle,
    bundleDir: bundleDir,
    excludeAssets: excludeAssets,
    logger: new Logger(logLevel)
  });
} else if (mode === 'static') {
  viewer.generateReport(bundleStats, {
    openBrowser: openBrowser,
    reportFilename: resolve(reportFilename || 'report.html'),
    reportTitle: reportTitle,
    defaultSizes: defaultSizes,
    bundleDir: bundleDir,
    excludeAssets: excludeAssets,
    logger: new Logger(logLevel)
  });
} else if (mode === 'json') {
  viewer.generateJSONReport(bundleStats, {
    reportFilename: resolve(reportFilename || 'report.json'),
    bundleDir: bundleDir,
    excludeAssets: excludeAssets,
    logger: new Logger(logLevel)
  });
}

function showHelp(error) {
  if (error) console.log("\n  ".concat(magenta(error), "\n"));
  program.outputHelp();
  process.exit(1);
}

function br(str) {
  return "\n".concat(_.repeat(' ', 28)).concat(str);
}

function array() {
  var arr = [];
  return function (val) {
    arr.push(val);
    return arr;
  };
}